#!/usr/bin/env python3
"""
Проверка создания пентеста и логи backend
"""

import paramiko

SSH_HOST = "72.56.79.153"
SSH_USER = "root"
SSH_PASSWORD = "m8J@2_6whwza6U"

def main():
    print("="*60)
    print("ПРОВЕРКА СОЗДАНИЯ ПЕНТЕСТА")
    print("="*60)
    
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(SSH_HOST, username=SSH_USER, password=SSH_PASSWORD, timeout=30)
    
    try:
        # Проверяем логи backend
        print("\n1. Последние логи backend:")
        stdin, stdout, stderr = ssh.exec_command("tail -50 /tmp/shannon-backend.log 2>&1 | tail -30")
        output = stdout.read().decode('utf-8', errors='replace')
        try:
            print(output[:1500])
        except:
            print(output[:1500].encode('ascii', 'replace').decode('ascii'))
        
        # Проверяем процессы backend
        print("\n2. Процессы backend:")
        stdin, stdout, stderr = ssh.exec_command("ps aux | grep -E 'uvicorn|python.*app.main' | grep -v grep")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output if output else "Backend не запущен")
        
        # Проверяем базу данных - сервисы
        print("\n3. Сервисы в базе данных:")
        stdin, stdout, stderr = ssh.exec_command("cd /root/shannon/backend && python3 -c \"from app.database import SessionLocal; from app.models.service import Service; db = SessionLocal(); services = db.query(Service).all(); print('Сервисы:', [(s.id, s.name, s.url) for s in services])\" 2>&1")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output)
        
        # Проверяем пентесты
        print("\n4. Пентесты в базе данных:")
        stdin, stdout, stderr = ssh.exec_command("cd /root/shannon/backend && python3 -c \"from app.database import SessionLocal; from app.models.pentest import Pentest; db = SessionLocal(); pentests = db.query(Pentest).all(); print('Пентесты:', [(p.id, p.name, p.target_url, p.status.value if hasattr(p.status, 'value') else str(p.status)) for p in pentests])\" 2>&1")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output)
        
    finally:
        ssh.close()

if __name__ == "__main__":
    main()

