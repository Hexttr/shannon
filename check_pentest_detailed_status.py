#!/usr/bin/env python3
"""
Детальная проверка статуса пентеста
"""

import paramiko

SSH_HOST = "72.56.79.153"
SSH_USER = "root"
SSH_PASSWORD = "m8J@2_6whwza6U"

def main():
    print("="*60)
    print("ДЕТАЛЬНАЯ ПРОВЕРКА СТАТУСА ПЕНТЕСТА")
    print("="*60)
    
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(SSH_HOST, username=SSH_USER, password=SSH_PASSWORD, timeout=30)
    
    try:
        # Проверяем пентест
        print("\n1. СТАТУС ПЕНТЕСТА В БАЗЕ ДАННЫХ:")
        stdin, stdout, stderr = ssh.exec_command("""
cd /root/shannon/backend && python3 << 'PYEOF'
from app.database import SessionLocal
from app.models.pentest import Pentest, PentestStatus
from datetime import datetime, timezone

db = SessionLocal()
pentest = db.query(Pentest).order_by(Pentest.created_at.desc()).first()

if pentest:
    print(f"ID: {pentest.id}")
    print(f"Название: {pentest.name}")
    print(f"URL: {pentest.target_url}")
    print(f"Статус: {pentest.status.value if hasattr(pentest.status, 'value') else pentest.status}")
    
    # Проверяем новые поля
    if hasattr(pentest, 'current_step'):
        print(f"Текущий шаг: {pentest.current_step}")
    if hasattr(pentest, 'step_progress'):
        print(f"Прогресс шагов: {pentest.step_progress}")
    
    print(f"Создан: {pentest.created_at}")
    print(f"Запущен: {pentest.started_at}")
    print(f"Завершен: {pentest.completed_at if pentest.completed_at else 'Нет'}")
    
    # Проверяем сколько времени прошло
    if pentest.started_at:
        now = datetime.now(timezone.utc)
        if pentest.started_at.tzinfo is None:
            from datetime import timezone
            pentest.started_at = pentest.started_at.replace(tzinfo=timezone.utc)
        elapsed = now - pentest.started_at
        print(f"Время работы: {elapsed}")
        
        # Если пентест работает больше 2 часов без завершения - возможно завис
        if pentest.status == PentestStatus.RUNNING and elapsed.total_seconds() > 7200:
            print("⚠️ ВНИМАНИЕ: Пентест работает более 2 часов - возможно завис!")
else:
    print("Пентесты не найдены")
PYEOF
""")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output)
        
        # Проверяем логи
        print("\n2. ПОСЛЕДНИЕ ЛОГИ:")
        stdin, stdout, stderr = ssh.exec_command("""
cd /root/shannon/backend && python3 << 'PYEOF'
from app.database import SessionLocal
from app.models.pentest import Pentest
from app.models.log import Log

db = SessionLocal()
pentest = db.query(Pentest).order_by(Pentest.created_at.desc()).first()

if pentest:
    logs = db.query(Log).filter(Log.pentest_id == pentest.id).order_by(Log.timestamp.desc()).limit(15).all()
    print(f"Всего логов: {db.query(Log).filter(Log.pentest_id == pentest.id).count()}")
    print("\nПоследние логи (от новых к старым):")
    for log in logs:
        level = log.level.value if hasattr(log.level, 'value') else str(log.level)
        print(f"[{log.timestamp}] [{level}] {log.message}")
PYEOF
""")
        output = stdout.read().decode('utf-8', errors='replace')
        try:
            print(output)
        except:
            print(output.encode('ascii', 'replace').decode('ascii'))
        
        # Проверяем процессы Python
        print("\n3. ПРОЦЕССЫ PYTHON:")
        stdin, stdout, stderr = ssh.exec_command("ps aux | grep python | grep -v grep")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output if output else "Нет процессов Python")
        
        # Проверяем временные файлы
        print("\n4. ВРЕМЕННЫЕ ФАЙЛЫ ПЕНТЕСТА:")
        stdin, stdout, stderr = ssh.exec_command("ls -lah /tmp/nmap_*.txt /tmp/nikto_*.txt /tmp/nuclei_*.txt /tmp/dirb_*.txt /tmp/sqlmap_*.txt 2>&1 | head -10")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output if output else "Временные файлы не найдены")
        
        # Проверяем размер файлов
        print("\n5. РАЗМЕР ВРЕМЕННЫХ ФАЙЛОВ:")
        stdin, stdout, stderr = ssh.exec_command("du -h /tmp/nmap_*.txt /tmp/nikto_*.txt /tmp/nuclei_*.txt /tmp/dirb_*.txt /tmp/sqlmap_*.txt 2>&1")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output if output else "Файлы не найдены")
        
    finally:
        ssh.close()

if __name__ == "__main__":
    main()

