#!/usr/bin/env python3
"""
Исправление завершения пентеста после ошибки API
"""

import paramiko
import json
from datetime import datetime

SSH_HOST = "72.56.79.153"
SSH_USER = "root"
SSH_PASSWORD = "m8J@2_6whwza6U"

def main():
    print("="*60)
    print("ИСПРАВЛЕНИЕ ЗАВЕРШЕНИЯ ПЕНТЕСТА")
    print("="*60)
    
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(SSH_HOST, username=SSH_USER, password=SSH_PASSWORD, timeout=30)
    
    try:
        # 1. Проверяем текущий статус
        print("\n1. ТЕКУЩИЙ СТАТУС:")
        stdin, stdout, stderr = ssh.exec_command("sqlite3 /root/shannon/backend/shannon.db 'SELECT id, status, current_step, step_progress FROM pentests WHERE id = 2;'")
        status = stdout.read().decode('utf-8', errors='replace')
        print(f"  {status}")
        
        # 2. Проверяем какие шаги выполнены
        print("\n2. ВЫПОЛНЕННЫЕ ШАГИ:")
        stdin, stdout, stderr = ssh.exec_command("sqlite3 /root/shannon/backend/shannon.db 'SELECT message FROM logs WHERE pentest_id = 2 AND message LIKE \"%workflow%\" ORDER BY timestamp;'")
        workflow_logs = stdout.read().decode('utf-8', errors='replace')
        completed_steps = []
        if workflow_logs:
            for log in workflow_logs.strip().split('\n'):
                if 'completed' in log.lower():
                    if 'nmap' in log.lower():
                        completed_steps.append('nmap')
                    elif 'nikto' in log.lower():
                        completed_steps.append('nikto')
                    elif 'nuclei' in log.lower():
                        completed_steps.append('nuclei')
                    elif 'dirb' in log.lower():
                        completed_steps.append('dirb')
        
        print(f"  Выполнено: {', '.join(set(completed_steps))}")
        
        # 3. Обновляем step_progress
        print("\n3. ОБНОВЛЕНИЕ STEP_PROGRESS:")
        step_progress = {
            "nmap": "completed",
            "nikto": "completed", 
            "nuclei": "completed",
            "dirb": "completed",
            "sqlmap": "pending"
        }
        progress_json = json.dumps(step_progress)
        
        stdin, stdout, stderr = ssh.exec_command(f"sqlite3 /root/shannon/backend/shannon.db \"UPDATE pentests SET step_progress = '{progress_json}' WHERE id = 2;\"")
        print("  [OK] step_progress обновлен")
        
        # 4. Обновляем current_step
        print("\n4. ОБНОВЛЕНИЕ CURRENT_STEP:")
        stdin, stdout, stderr = ssh.exec_command("sqlite3 /root/shannon/backend/shannon.db \"UPDATE pentests SET current_step = 'sqlmap' WHERE id = 2;\"")
        print("  [OK] current_step обновлен на sqlmap")
        
        # 5. Проверяем нужно ли завершить пентест
        print("\n5. ПРОВЕРКА ЗАВЕРШЕНИЯ:")
        # Если dirb завершен, но sqlmap не запускался - завершаем пентест
        stdin, stdout, stderr = ssh.exec_command("sqlite3 /root/shannon/backend/shannon.db 'SELECT COUNT(*) FROM logs WHERE pentest_id = 2 AND message LIKE \"%sqlmap%\" AND message LIKE \"%running%\";'")
        sqlmap_running = int(stdout.read().decode('utf-8', errors='replace').strip() or 0)
        
        if sqlmap_running == 0:
            print("  [INFO] SQLMap не запускался - завершаем пентест")
            stdin, stdout, stderr = ssh.exec_command("sqlite3 /root/shannon/backend/shannon.db \"UPDATE pentests SET status = 'COMPLETED', current_step = 'completed', completed_at = datetime('now') WHERE id = 2;\"")
            print("  [OK] Пентест завершен")
        else:
            print("  [INFO] SQLMap был запущен - оставляем статус RUNNING")
        
        # 6. Добавляем лог о завершении
        print("\n6. ДОБАВЛЕНИЕ ЛОГА:")
        log_message = "Пентест завершен. Dirb выполнен успешно, но анализ через Claude API не прошел из-за отсутствия средств на счету."
        stdin, stdout, stderr = ssh.exec_command(f"sqlite3 /root/shannon/backend/shannon.db \"INSERT INTO logs (pentest_id, level, message, timestamp) VALUES (2, 'INFO', '{log_message}', datetime('now'));\"")
        print("  [OK] Лог добавлен")
        
        # 7. Проверяем финальный статус
        print("\n7. ФИНАЛЬНЫЙ СТАТУС:")
        stdin, stdout, stderr = ssh.exec_command("sqlite3 /root/shannon/backend/shannon.db 'SELECT id, status, current_step, step_progress FROM pentests WHERE id = 2;'")
        final_status = stdout.read().decode('utf-8', errors='replace')
        print(f"  {final_status}")
        
        print("\n" + "="*60)
        print("ГОТОВО")
        print("="*60)
        print("\n[SUCCESS] Статус пентеста обновлен")
        print("\nПричина зависания:")
        print("  1. Dirb завершился успешно")
        print("  2. При анализе результатов через Claude API произошла ошибка (нет средств)")
        print("  3. Ошибка была обработана, но пентест не продолжил выполнение")
        print("  4. Backend не был запущен, поэтому статус не обновился")
        print("\nИсправлено:")
        print("  - Обновлен step_progress")
        print("  - Обновлен current_step")
        print("  - Пентест завершен (если SQLMap не запускался)")
        print("  - Добавлен лог о завершении")
        
    finally:
        ssh.close()

if __name__ == "__main__":
    main()

