#!/usr/bin/env python3
"""
Подготовка сервера к пентесту - установка всех необходимых инструментов
"""

import paramiko
import sys
import time

SSH_HOST = "72.56.79.153"
SSH_USER = "root"
SSH_PASSWORD = "m8J@2_6whwza6U"

TOOLS = {
    "nmap": {
        "check": "which nmap",
        "install": "apt-get update && apt-get install -y nmap",
    },
    "nikto": {
        "check": "which nikto",
        "install": "apt-get update && apt-get install -y nikto",
    },
    "sqlmap": {
        "check": "which sqlmap",
        "install": "apt-get update && apt-get install -y sqlmap",
    },
    "nuclei": {
        "check": "which nuclei",
        "install": "wget -q https://github.com/projectdiscovery/nuclei/releases/latest/download/nuclei_3.2.7_linux_amd64.zip -O /tmp/nuclei.zip && unzip -q /tmp/nuclei.zip -d /tmp && mv /tmp/nuclei /usr/local/bin/ && chmod +x /usr/local/bin/nuclei && rm /tmp/nuclei.zip",
    },
    "dirb": {
        "check": "which dirb",
        "install": "apt-get update && apt-get install -y dirb",
    },
    "gobuster": {
        "check": "which gobuster",
        "install": "apt-get update && apt-get install -y gobuster",
    },
    "wpscan": {
        "check": "which wpscan",
        "install": "apt-get update && apt-get install -y wpscan",
    },
    "whatweb": {
        "check": "which whatweb",
        "install": "apt-get update && apt-get install -y whatweb",
    },
    "subfinder": {
        "check": "which subfinder",
        "install": "wget -q https://github.com/projectdiscovery/subfinder/releases/latest/download/subfinder_2.6.7_linux_amd64.zip -O /tmp/subfinder.zip && unzip -q /tmp/subfinder.zip -d /tmp && mv /tmp/subfinder /usr/local/bin/ && chmod +x /usr/local/bin/subfinder && rm /tmp/subfinder.zip",
    },
    "httpx": {
        "check": "which httpx",
        "install": "wget -q https://github.com/projectdiscovery/httpx/releases/latest/download/httpx_1.3.7_linux_amd64.zip -O /tmp/httpx.zip && unzip -q /tmp/httpx.zip -d /tmp && mv /tmp/httpx /usr/local/bin/ && chmod +x /usr/local/bin/httpx && rm /tmp/httpx.zip",
    },
}

def execute_command(ssh, command, description):
    """Выполняет команду и возвращает результат"""
    print(f"\n{description}")
    stdin, stdout, stderr = ssh.exec_command(command, timeout=600)
    exit_status = stdout.channel.recv_exit_status()
    output = stdout.read().decode('utf-8', errors='replace')
    error_output = stderr.read().decode('utf-8', errors='replace')
    
    if output:
        try:
            print(output[:500])
        except:
            print(output[:500].encode('ascii', 'replace').decode('ascii'))
    
    if error_output and exit_status != 0:
        try:
            print(f"ERROR: {error_output[:300]}")
        except:
            print(f"ERROR: {error_output[:300].encode('ascii', 'replace').decode('ascii')}")
    
    return exit_status == 0, output

def check_tool(ssh, tool_name):
    """Проверяет установлен ли инструмент"""
    stdin, stdout, stderr = ssh.exec_command(TOOLS[tool_name]["check"])
    exit_code = stdout.channel.recv_exit_status()
    return exit_code == 0

def install_tool(ssh, tool_name):
    """Устанавливает инструмент"""
    if check_tool(ssh, tool_name):
        print(f"[OK] {tool_name} уже установлен")
        return True
    
    print(f"[INSTALL] Установка {tool_name}...")
    success, output = execute_command(ssh, TOOLS[tool_name]["install"], f"Установка {tool_name}")
    
    if success and check_tool(ssh, tool_name):
        print(f"[OK] {tool_name} успешно установлен")
        return True
    else:
        print(f"[ERROR] Не удалось установить {tool_name}")
        return False

def main():
    print("="*60)
    print("ПОДГОТОВКА СЕРВЕРА К ПЕНТЕСТУ")
    print("="*60)
    
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(SSH_HOST, username=SSH_USER, password=SSH_PASSWORD, timeout=30)
    
    try:
        # Устанавливаем необходимые пакеты
        print("\n1. Установка базовых пакетов...")
        execute_command(ssh, "apt-get update", "Обновление списка пакетов")
        execute_command(ssh, "apt-get install -y unzip wget curl", "Установка базовых утилит")
        
        # Проверяем и устанавливаем инструменты
        print("\n2. Проверка и установка инструментов пентестинга...")
        results = {}
        
        for tool_name in TOOLS.keys():
            results[tool_name] = install_tool(ssh, tool_name)
            time.sleep(1)  # Небольшая пауза между установками
        
        # Проверяем версии установленных инструментов
        print("\n3. Проверка версий установленных инструментов...")
        for tool_name in TOOLS.keys():
            if results[tool_name]:
                stdin, stdout, stderr = ssh.exec_command(f"{tool_name} --version 2>&1 | head -1 || {tool_name} -v 2>&1 | head -1 || echo 'версия неизвестна'")
                version = stdout.read().decode('utf-8', errors='replace').strip()
                print(f"  {tool_name}: {version}")
        
        # Проверяем что backend работает
        print("\n4. Проверка backend...")
        stdin, stdout, stderr = ssh.exec_command("ps aux | grep -E 'uvicorn|python.*app.main' | grep -v grep")
        backend_running = stdout.read().decode('utf-8', errors='replace').strip()
        if backend_running:
            print("[OK] Backend работает")
        else:
            print("[WARN] Backend не запущен")
        
        # Итоговый отчет
        print("\n" + "="*60)
        print("ИТОГОВЫЙ ОТЧЕТ")
        print("="*60)
        
        installed_count = sum(1 for v in results.values() if v)
        total_count = len(results)
        
        print(f"\nУстановлено инструментов: {installed_count}/{total_count}")
        
        for tool_name, installed in results.items():
            status = "[OK]" if installed else "[ERROR]"
            print(f"  {status} {tool_name}")
        
        if installed_count == total_count:
            print("\n[SUCCESS] Все инструменты готовы к пентесту!")
        else:
            print(f"\n[WARN] Некоторые инструменты не установлены ({total_count - installed_count})")
        
        print("\nСервер готов к проведению пентестов!")
        
    finally:
        ssh.close()

if __name__ == "__main__":
    main()

