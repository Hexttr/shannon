#!/usr/bin/env python3
"""
Сброс зависшего пентеста
"""

import paramiko

SSH_HOST = "72.56.79.153"
SSH_USER = "root"
SSH_PASSWORD = "m8J@2_6whwza6U"

def main():
    print("="*60)
    print("СБРОС ЗАВИСШЕГО ПЕНТЕСТА")
    print("="*60)
    
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(SSH_HOST, username=SSH_USER, password=SSH_PASSWORD, timeout=30)
    
    try:
        # Обновляем статус зависшего пентеста
        print("\n1. Обновляю статус зависшего пентеста...")
        stdin, stdout, stderr = ssh.exec_command("""
cd /root/shannon/backend && python3 << 'PYEOF'
from app.database import SessionLocal
from app.models.pentest import Pentest, PentestStatus
from datetime import datetime, timezone

db = SessionLocal()
pentest = db.query(Pentest).filter(Pentest.id == 1).first()

if pentest and pentest.status == PentestStatus.RUNNING:
    # Проверяем сколько времени прошло
    if pentest.started_at:
        now = datetime.now(timezone.utc)
        if pentest.started_at.tzinfo is None:
            pentest.started_at = pentest.started_at.replace(tzinfo=timezone.utc)
        elapsed = now - pentest.started_at
        
        # Если больше 30 минут - помечаем как failed
        if elapsed.total_seconds() > 1800:
            print(f"Пентест завис (работает {elapsed.total_seconds()/60:.1f} минут)")
            pentest.status = PentestStatus.FAILED
            pentest.completed_at = datetime.now(timezone.utc)
            if hasattr(pentest, 'current_step'):
                pentest.current_step = 'failed'
            db.commit()
            print("Статус обновлен на FAILED")
        else:
            print(f"Пентест работает {elapsed.total_seconds()/60:.1f} минут - это нормально")
    else:
        print("Пентест не запущен")
else:
    print(f"Пентест в статусе: {pentest.status.value if pentest else 'не найден'}")
PYEOF
""")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output)
        
        # Проверяем финальный статус
        print("\n2. Финальный статус:")
        stdin, stdout, stderr = ssh.exec_command("sqlite3 /root/shannon/backend/shannon.db 'SELECT id, name, status FROM pentests WHERE id = 1;'")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output)
        
    finally:
        ssh.close()

if __name__ == "__main__":
    main()

