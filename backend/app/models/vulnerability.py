from sqlalchemy import Column, String, DateTime, Integer, ForeignKey, Float, Text, Enum as SQLEnum
from sqlalchemy.sql import func
from sqlalchemy.orm import relationship
import enum
from app.database import Base


class Severity(str, enum.Enum):
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


class Vulnerability(Base):
    __tablename__ = "vulnerabilities"
    
    id = Column(Integer, primary_key=True, index=True)
    pentest_id = Column(Integer, ForeignKey("pentests.id"), nullable=False)
    type = Column(String, nullable=False)  # Тип уязвимости (SQL Injection, XSS, etc.)
    title = Column(String, nullable=False)
    severity = Column(SQLEnum(Severity), nullable=False)
    description = Column(Text, nullable=True)
    location = Column(String, nullable=True)  # URL или путь где найдена уязвимость
    cvss_score = Column(Float, nullable=True)
    exploit = Column(Text, nullable=True)  # Сгенерированный эксплойт
    recommendation = Column(Text, nullable=True)  # Рекомендация по исправлению
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    
    # Relationships
    pentest = relationship("Pentest", back_populates="vulnerabilities")

