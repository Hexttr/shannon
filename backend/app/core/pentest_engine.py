"""
–î–≤–∏–∂–æ–∫ –ø–µ–Ω—Ç–µ—Å—Ç–∏–Ω–≥–∞ - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏ –∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
"""
import asyncio
import logging
from datetime import datetime
from typing import List, Dict, Any
from sqlalchemy.orm import Session
from app.core.ssh_client import SSHClient
from app.core.tools_installer import ensure_tools_installed
from app.core.claude_client import ClaudeClient
from app.core.websocket_manager import emit_pentest_status, emit_pentest_log, emit_pentest_vulnerability
from app.models.pentest import Pentest, PentestStatus
from app.models.vulnerability import Vulnerability, Severity
from app.models.log import Log, LogLevel

logger = logging.getLogger(__name__)


class PentestEngine:
    """–î–≤–∏–∂–æ–∫ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–µ–Ω—Ç–µ—Å—Ç–æ–≤"""
    
    def __init__(self, db: Session, pentest_id: int):
        self.db = db
        self.pentest_id = pentest_id
        self.ssh_client = SSHClient()
        self.claude_client = ClaudeClient()
        self.pentest: Pentest = db.query(Pentest).filter(Pentest.id == pentest_id).first()
        self.target_url = self.pentest.target_url
        self.running = False
    
    def add_log(self, level: LogLevel, message: str):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∞"""
        log = Log(
            pentest_id=self.pentest_id,
            level=level,
            message=message
        )
        self.db.add(log)
        self.db.commit()
        logger.info(f"[Pentest {self.pentest_id}] {level.value.upper()}: {message}")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket
        try:
            import asyncio
            loop = asyncio.get_event_loop()
            if loop.is_running():
                asyncio.create_task(emit_pentest_log(self.pentest_id, {
                    'level': level.value,
                    'message': message,
                    'timestamp': datetime.utcnow().isoformat()
                }))
            else:
                loop.run_until_complete(emit_pentest_log(self.pentest_id, {
                    'level': level.value,
                    'message': message,
                    'timestamp': datetime.utcnow().isoformat()
                }))
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥ —á–µ—Ä–µ–∑ WebSocket: {e}")
    
    def run(self):
        """–ó–∞–ø—É—Å–∫ –ø–µ–Ω—Ç–µ—Å—Ç–∞"""
        if self.running:
            raise ValueError("–ü–µ–Ω—Ç–µ—Å—Ç —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è")
        
        self.running = True
        
        try:
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            self.pentest.status = PentestStatus.RUNNING
            self.pentest.started_at = datetime.utcnow()
            self.db.commit()
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ WebSocket
            try:
                import asyncio
                loop = asyncio.get_event_loop()
                if loop.is_running():
                    asyncio.create_task(emit_pentest_status(self.pentest_id, PentestStatus.RUNNING.value))
                else:
                    loop.run_until_complete(emit_pentest_status(self.pentest_id, PentestStatus.RUNNING.value))
            except Exception as e:
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ WebSocket: {e}")
            
            self.add_log(LogLevel.INFO, f"üöÄ –ó–∞–ø—É—Å–∫ –ø–µ–Ω—Ç–µ—Å—Ç–∞ –¥–ª—è {self.target_url}")
            
            # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
            if not self.ssh_client.connect():
                raise ConnectionError("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É")
            
            self.add_log(LogLevel.INFO, "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ")
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            self.add_log(LogLevel.INFO, "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤...")
            ensure_tools_installed(self.ssh_client)
            self.add_log(LogLevel.INFO, "‚úÖ –í—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≥–æ—Ç–æ–≤—ã")
            
            # –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            self._run_nmap_scan()
            self._run_nikto_scan()
            self._run_nuclei_scan()
            self._run_dirb_scan()
            self._run_sqlmap_scan()
            
            # –ó–∞–≤–µ—Ä—à–∞–µ–º –ø–µ–Ω—Ç–µ—Å—Ç
            self.pentest.status = PentestStatus.COMPLETED
            self.pentest.completed_at = datetime.utcnow()
            self.db.commit()
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ WebSocket
            try:
                import asyncio
                loop = asyncio.get_event_loop()
                if loop.is_running():
                    asyncio.create_task(emit_pentest_status(self.pentest_id, PentestStatus.COMPLETED.value))
                else:
                    loop.run_until_complete(emit_pentest_status(self.pentest_id, PentestStatus.COMPLETED.value))
            except Exception as e:
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ WebSocket: {e}")
            
            self.add_log(LogLevel.INFO, "‚úÖ –ü–µ–Ω—Ç–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω")
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø–µ–Ω—Ç–µ—Å—Ç–∞: {e}")
            self.pentest.status = PentestStatus.FAILED
            self.db.commit()
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ WebSocket
            try:
                import asyncio
                loop = asyncio.get_event_loop()
                if loop.is_running():
                    asyncio.create_task(emit_pentest_status(self.pentest_id, PentestStatus.FAILED.value))
                else:
                    loop.run_until_complete(emit_pentest_status(self.pentest_id, PentestStatus.FAILED.value))
            except Exception as e2:
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ WebSocket: {e2}")
            
            self.add_log(LogLevel.ERROR, f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
        finally:
            self.ssh_client.disconnect()
            self.running = False
    
    def _run_nmap_scan(self):
        """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ Nmap —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"""
        self.add_log(LogLevel.INFO, "üîç –ó–∞–ø—É—Å–∫ Nmap —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...")
        
        try:
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ö–æ—Å—Ç –∏–∑ URL
            host = self.target_url.replace("https://", "").replace("http://", "").split("/")[0]
            
            # –ü–æ–ª–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤
            command = f"nmap -sS -sV -sC -A -p- {host} -oN /tmp/nmap_{self.pentest_id}.txt"
            exit_code, stdout, stderr = self.ssh_client.execute_command(command, timeout=1800)
            
            if exit_code == 0:
                # –ß–∏—Ç–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                _, results, _ = self.ssh_client.execute_command(f"cat /tmp/nmap_{self.pentest_id}.txt")
                
                # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ Claude
                analysis = self.claude_client.analyze_scan_results(
                    "Nmap",
                    self.target_url,
                    results
                )
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º —É—è–∑–≤–∏–º–æ—Å—Ç–∏
                vulnerabilities = analysis.get("vulnerabilities", [])
                self._save_vulnerabilities(vulnerabilities)
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É—è–∑–≤–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ WebSocket
                for vuln in vulnerabilities:
                    try:
                        import asyncio
                        loop = asyncio.get_event_loop()
                        if loop.is_running():
                            asyncio.create_task(emit_pentest_vulnerability(self.pentest_id, vuln))
                        else:
                            loop.run_until_complete(emit_pentest_vulnerability(self.pentest_id, vuln))
                    except Exception as e:
                        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ WebSocket: {e}")
                
                self.add_log(LogLevel.INFO, f"‚úÖ Nmap: –Ω–∞–π–¥–µ–Ω–æ {len(vulnerabilities)} —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π")
            else:
                self.add_log(LogLevel.WARNING, f"‚ö†Ô∏è Nmap –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π: {stderr}")
                
        except Exception as e:
            self.add_log(LogLevel.ERROR, f"‚ùå –û—à–∏–±–∫–∞ Nmap: {str(e)}")
    
    def _run_nikto_scan(self):
        """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ Nikto —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"""
        self.add_log(LogLevel.INFO, "üîç –ó–∞–ø—É—Å–∫ Nikto —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...")
        
        try:
            command = f"nikto -h {self.target_url} -Format txt -output /tmp/nikto_{self.pentest_id}.txt"
            exit_code, stdout, stderr = self.ssh_client.execute_command(command, timeout=1800)
            
            if exit_code == 0 or exit_code == 1:  # Nikto –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 1 –ø—Ä–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö
                _, results, _ = self.ssh_client.execute_command(f"cat /tmp/nikto_{self.pentest_id}.txt")
                
                analysis = self.claude_client.analyze_scan_results(
                    "Nikto",
                    self.target_url,
                    results
                )
                
                vulnerabilities = analysis.get("vulnerabilities", [])
                self._save_vulnerabilities(vulnerabilities)
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É—è–∑–≤–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ WebSocket
                for vuln in vulnerabilities:
                    try:
                        import asyncio
                        loop = asyncio.get_event_loop()
                        if loop.is_running():
                            asyncio.create_task(emit_pentest_vulnerability(self.pentest_id, vuln))
                        else:
                            loop.run_until_complete(emit_pentest_vulnerability(self.pentest_id, vuln))
                    except Exception as e:
                        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ WebSocket: {e}")
                
                self.add_log(LogLevel.INFO, f"‚úÖ Nikto: –Ω–∞–π–¥–µ–Ω–æ {len(vulnerabilities)} —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π")
            else:
                self.add_log(LogLevel.WARNING, f"‚ö†Ô∏è Nikto –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π")
                
        except Exception as e:
            self.add_log(LogLevel.ERROR, f"‚ùå –û—à–∏–±–∫–∞ Nikto: {str(e)}")
    
    def _run_nuclei_scan(self):
        """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ Nuclei —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"""
        self.add_log(LogLevel.INFO, "üîç –ó–∞–ø—É—Å–∫ Nuclei —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...")
        
        try:
            # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑—ã Nuclei
            self.ssh_client.execute_command("nuclei -update-templates", timeout=300)
            
            command = f"nuclei -u {self.target_url} -o /tmp/nuclei_{self.pentest_id}.txt -json"
            exit_code, stdout, stderr = self.ssh_client.execute_command(command, timeout=1800)
            
            if exit_code == 0:
                _, results, _ = self.ssh_client.execute_command(f"cat /tmp/nuclei_{self.pentest_id}.txt")
                
                analysis = self.claude_client.analyze_scan_results(
                    "Nuclei",
                    self.target_url,
                    results
                )
                
                vulnerabilities = analysis.get("vulnerabilities", [])
                self._save_vulnerabilities(vulnerabilities)
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É—è–∑–≤–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ WebSocket
                for vuln in vulnerabilities:
                    try:
                        import asyncio
                        loop = asyncio.get_event_loop()
                        if loop.is_running():
                            asyncio.create_task(emit_pentest_vulnerability(self.pentest_id, vuln))
                        else:
                            loop.run_until_complete(emit_pentest_vulnerability(self.pentest_id, vuln))
                    except Exception as e:
                        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ WebSocket: {e}")
                
                self.add_log(LogLevel.INFO, f"‚úÖ Nuclei: –Ω–∞–π–¥–µ–Ω–æ {len(vulnerabilities)} —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π")
            else:
                self.add_log(LogLevel.WARNING, f"‚ö†Ô∏è Nuclei –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π")
                
        except Exception as e:
            self.add_log(LogLevel.ERROR, f"‚ùå –û—à–∏–±–∫–∞ Nuclei: {str(e)}")
    
    def _run_dirb_scan(self):
        """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ Dirb —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"""
        self.add_log(LogLevel.INFO, "üîç –ó–∞–ø—É—Å–∫ Dirb —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...")
        
        try:
            command = f"dirb {self.target_url} -o /tmp/dirb_{self.pentest_id}.txt"
            exit_code, stdout, stderr = self.ssh_client.execute_command(command, timeout=1800)
            
            if exit_code == 0:
                _, results, _ = self.ssh_client.execute_command(f"cat /tmp/dirb_{self.pentest_id}.txt")
                
                analysis = self.claude_client.analyze_scan_results(
                    "Dirb",
                    self.target_url,
                    results
                )
                
                vulnerabilities = analysis.get("vulnerabilities", [])
                self._save_vulnerabilities(vulnerabilities)
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É—è–∑–≤–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ WebSocket
                for vuln in vulnerabilities:
                    try:
                        import asyncio
                        loop = asyncio.get_event_loop()
                        if loop.is_running():
                            asyncio.create_task(emit_pentest_vulnerability(self.pentest_id, vuln))
                        else:
                            loop.run_until_complete(emit_pentest_vulnerability(self.pentest_id, vuln))
                    except Exception as e:
                        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ WebSocket: {e}")
                
                self.add_log(LogLevel.INFO, f"‚úÖ Dirb: –Ω–∞–π–¥–µ–Ω–æ {len(vulnerabilities)} —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π")
            else:
                self.add_log(LogLevel.WARNING, f"‚ö†Ô∏è Dirb –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π")
                
        except Exception as e:
            self.add_log(LogLevel.ERROR, f"‚ùå –û—à–∏–±–∫–∞ Dirb: {str(e)}")
    
    def _run_sqlmap_scan(self):
        """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQLMap —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"""
        self.add_log(LogLevel.INFO, "üîç –ó–∞–ø—É—Å–∫ SQLMap —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...")
        
        try:
            # SQLMap —Ç–æ–ª—å–∫–æ –¥–ª—è URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            if "?" in self.target_url:
                command = f"sqlmap -u '{self.target_url}' --batch --crawl=2 -o /tmp/sqlmap_{self.pentest_id}.txt"
                exit_code, stdout, stderr = self.ssh_client.execute_command(command, timeout=1800)
                
                if exit_code == 0:
                    _, results, _ = self.ssh_client.execute_command(f"cat /tmp/sqlmap_{self.pentest_id}.txt")
                    
                    analysis = self.claude_client.analyze_scan_results(
                        "SQLMap",
                        self.target_url,
                        results
                    )
                    
                    vulnerabilities = analysis.get("vulnerabilities", [])
                    self._save_vulnerabilities(vulnerabilities)
                    
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É—è–∑–≤–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ WebSocket
                    for vuln in vulnerabilities:
                        try:
                            import asyncio
                            loop = asyncio.get_event_loop()
                            if loop.is_running():
                                asyncio.create_task(emit_pentest_vulnerability(self.pentest_id, vuln))
                            else:
                                loop.run_until_complete(emit_pentest_vulnerability(self.pentest_id, vuln))
                        except Exception as e:
                            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ WebSocket: {e}")
                    
                    self.add_log(LogLevel.INFO, f"‚úÖ SQLMap: –Ω–∞–π–¥–µ–Ω–æ {len(vulnerabilities)} —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π")
                else:
                    self.add_log(LogLevel.WARNING, f"‚ö†Ô∏è SQLMap –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π")
            else:
                self.add_log(LogLevel.INFO, "‚è≠Ô∏è SQLMap –ø—Ä–æ–ø—É—â–µ–Ω (–Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ URL)")
                
        except Exception as e:
            self.add_log(LogLevel.ERROR, f"‚ùå –û—à–∏–±–∫–∞ SQLMap: {str(e)}")
    
    def _save_vulnerabilities(self, vulnerabilities: List[Dict[str, Any]]):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ –ë–î"""
        for vuln_data in vulnerabilities:
            try:
                vulnerability = Vulnerability(
                    pentest_id=self.pentest_id,
                    type=vuln_data.get("type", "Unknown"),
                    title=vuln_data.get("title", "Untitled"),
                    severity=Severity(vuln_data.get("severity", "low")),
                    description=vuln_data.get("description"),
                    location=vuln_data.get("location"),
                    cvss_score=vuln_data.get("cvss_score"),
                    exploit=vuln_data.get("exploit"),
                    recommendation=vuln_data.get("recommendation")
                )
                self.db.add(vulnerability)
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–∏: {e}")
        
        self.db.commit()

