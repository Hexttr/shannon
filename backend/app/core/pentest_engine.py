"""
–î–≤–∏–∂–æ–∫ –ø–µ–Ω—Ç–µ—Å—Ç–∏–Ω–≥–∞ - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏ –∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
"""
import asyncio
import logging
from datetime import datetime
from typing import List, Dict, Any
from sqlalchemy.orm import Session
from app.core.ssh_client import SSHClient
from app.core.tools_installer import ensure_tools_installed
from app.core.claude_client import ClaudeClient
from app.core.websocket_manager import emit_pentest_status, emit_pentest_log, emit_pentest_vulnerability
from app.models.pentest import Pentest, PentestStatus
from app.models.vulnerability import Vulnerability, Severity
from app.models.log import Log, LogLevel
from app.config import settings
import socket

logger = logging.getLogger(__name__)


class PentestEngine:
    """–î–≤–∏–∂–æ–∫ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–µ–Ω—Ç–µ—Å—Ç–æ–≤"""
    
    def __init__(self, db: Session, pentest_id: int):
        self.db = db
        self.pentest_id = pentest_id
        self.ssh_client = SSHClient()
        self.claude_client = ClaudeClient()
        self.pentest: Pentest = db.query(Pentest).filter(Pentest.id == pentest_id).first()
        self.target_url = self.pentest.target_url
        self.running = False
    
    def _check_self_scanning(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ —Å–∫–∞–Ω–∏—Ä—É–µ–º –ª–∏ –º—ã —Å–∞–º–∏ —Å–µ–±—è (white box –≤–º–µ—Å—Ç–æ black box)"""
        server_host = settings.ssh_host
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ö–æ—Å—Ç –∏–∑ target_url
        target_host = self.target_url.replace("https://", "").replace("http://", "").split("/")[0]
        target_host = target_host.split(":")[0]  # –£–±–∏—Ä–∞–µ–º –ø–æ—Ä—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ö–æ—Å—Ç–∞
        if target_host == server_host or target_host in ["localhost", "127.0.0.1", "0.0.0.0"]:
            raise ValueError(
                f"‚ö†Ô∏è –û–®–ò–ë–ö–ê: –ü–æ–ø—ã—Ç–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º —Å–µ—Ä–≤–µ—Ä ({server_host}). "
                f"–≠—Ç–æ white box —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø—Ä–æ–±–ª–µ–º–∞–º. "
                f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–Ω–µ—à–Ω–∏–π —Ä–µ—Å—É—Ä—Å –¥–ª—è black box —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è."
            )
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ DNS —Ä–µ–∑–æ–ª–≤–∏–Ω–≥
        try:
            target_ip = socket.gethostbyname(target_host)
            server_ip = socket.gethostbyname(server_host)
            
            if target_ip == server_ip:
                raise ValueError(
                    f"‚ö†Ô∏è –û–®–ò–ë–ö–ê: IP –∞–¥—Ä–µ—Å —Ü–µ–ª–∏ ({target_ip}) —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å IP —Å–µ—Ä–≤–µ—Ä–∞ ({server_ip}). "
                    f"–≠—Ç–æ white box —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ."
                )
        except socket.gaierror:
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–∑–æ–ª–≤–∏—Ç—å, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É IP
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å IP —á–µ—Ä–µ–∑ DNS –¥–ª—è {target_host}")
        except Exception as e:
            logger.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ self-scanning: {e}")
        
        self.add_log(LogLevel.INFO, f"‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞: —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–≥–æ —Ä–µ—Å—É—Ä—Å–∞ ({target_host})")
    
    def _set_step(self, step_name: str, status: str = "running"):
        """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞ workflow"""
        self.pentest.current_step = step_name
        if not self.pentest.step_progress:
            self.pentest.step_progress = {}
        self.pentest.step_progress[step_name] = status
        self.db.commit()
        
        self.add_log(LogLevel.INFO, f"üìã –®–∞–≥ workflow: {step_name} - {status}")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket
        try:
            import asyncio
            loop = asyncio.get_event_loop()
            if loop.is_running():
                asyncio.create_task(emit_pentest_status(self.pentest_id, PentestStatus.RUNNING.value))
            else:
                loop.run_until_complete(emit_pentest_status(self.pentest_id, PentestStatus.RUNNING.value))
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —à–∞–≥–∞ —á–µ—Ä–µ–∑ WebSocket: {e}")
    
    def add_log(self, level: LogLevel, message: str):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∞"""
        log = Log(
            pentest_id=self.pentest_id,
            level=level,
            message=message
        )
        self.db.add(log)
        self.db.commit()
        logger.info(f"[Pentest {self.pentest_id}] {level.value.upper()}: {message}")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket
        try:
            import asyncio
            loop = asyncio.get_event_loop()
            if loop.is_running():
                asyncio.create_task(emit_pentest_log(self.pentest_id, {
                    'level': level.value,
                    'message': message,
                    'timestamp': datetime.utcnow().isoformat()
                }))
            else:
                loop.run_until_complete(emit_pentest_log(self.pentest_id, {
                    'level': level.value,
                    'message': message,
                    'timestamp': datetime.utcnow().isoformat()
                }))
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥ —á–µ—Ä–µ–∑ WebSocket: {e}")
    
    def run(self):
        """–ó–∞–ø—É—Å–∫ –ø–µ–Ω—Ç–µ—Å—Ç–∞"""
        if self.running:
            raise ValueError("–ü–µ–Ω—Ç–µ—Å—Ç —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è")
        
        self.running = True
        
        try:
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            self.pentest.status = PentestStatus.RUNNING
            self.pentest.started_at = datetime.utcnow()
            self.db.commit()
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ WebSocket
            try:
                import asyncio
                loop = asyncio.get_event_loop()
                if loop.is_running():
                    asyncio.create_task(emit_pentest_status(self.pentest_id, PentestStatus.RUNNING.value))
                else:
                    loop.run_until_complete(emit_pentest_status(self.pentest_id, PentestStatus.RUNNING.value))
            except Exception as e:
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ WebSocket: {e}")
            
            self.add_log(LogLevel.INFO, f"üöÄ –ó–∞–ø—É—Å–∫ –ø–µ–Ω—Ç–µ—Å—Ç–∞ –¥–ª—è {self.target_url}")
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ self-scanning (white box)
            self._check_self_scanning()
            
            # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
            if not self.ssh_client.connect():
                raise ConnectionError("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É")
            
            self.add_log(LogLevel.INFO, "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ")
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            self.add_log(LogLevel.INFO, "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤...")
            ensure_tools_installed(self.ssh_client)
            self.add_log(LogLevel.INFO, "‚úÖ –í—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≥–æ—Ç–æ–≤—ã")
            
            # –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º workflow
            try:
                self._set_step("nmap", "running")
                self._run_nmap_scan()
                self._set_step("nmap", "completed")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ Nmap: {e}")
                self._set_step("nmap", "failed")
                raise
            
            try:
                self._set_step("nikto", "running")
                self._run_nikto_scan()
                self._set_step("nikto", "completed")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ Nikto: {e}")
                self._set_step("nikto", "failed")
                raise
            
            try:
                self._set_step("nuclei", "running")
                self._run_nuclei_scan()
                self._set_step("nuclei", "completed")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ Nuclei: {e}")
                self._set_step("nuclei", "failed")
                raise
            
            try:
                self._set_step("dirb", "running")
                self._run_dirb_scan()
                self._set_step("dirb", "completed")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ Dirb: {e}")
                self._set_step("dirb", "failed")
                raise
            
            try:
                self._set_step("sqlmap", "running")
                self._run_sqlmap_scan()
                self._set_step("sqlmap", "completed")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ SQLMap: {e}")
                self._set_step("sqlmap", "failed")
                raise
            
            self._set_step("completed", "completed")
            
            # –ó–∞–≤–µ—Ä—à–∞–µ–º –ø–µ–Ω—Ç–µ—Å—Ç
            self.pentest.status = PentestStatus.COMPLETED
            self.pentest.completed_at = datetime.utcnow()
            self.db.commit()
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ WebSocket
            try:
                import asyncio
                loop = asyncio.get_event_loop()
                if loop.is_running():
                    asyncio.create_task(emit_pentest_status(self.pentest_id, PentestStatus.COMPLETED.value))
                else:
                    loop.run_until_complete(emit_pentest_status(self.pentest_id, PentestStatus.COMPLETED.value))
            except Exception as e:
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ WebSocket: {e}")
            
            self.add_log(LogLevel.INFO, "‚úÖ –ü–µ–Ω—Ç–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω")
            
        except Exception as e:
            import traceback
            error_traceback = traceback.format_exc()
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø–µ–Ω—Ç–µ—Å—Ç–∞: {e}\n{error_traceback}")
            
            # –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            try:
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                self.pentest.status = PentestStatus.FAILED
                self.pentest.completed_at = datetime.utcnow()
                if hasattr(self.pentest, 'current_step'):
                    self.pentest.current_step = "failed"
                self.db.commit()
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ WebSocket
                try:
                    import asyncio
                    loop = asyncio.get_event_loop()
                    if loop.is_running():
                        asyncio.create_task(emit_pentest_status(self.pentest_id, PentestStatus.FAILED.value))
                    else:
                        loop.run_until_complete(emit_pentest_status(self.pentest_id, PentestStatus.FAILED.value))
                except Exception as e2:
                    logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ WebSocket: {e2}")
                
                self.add_log(LogLevel.ERROR, f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
            except Exception as e3:
                logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: {e3}")
        finally:
            # –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∏ —Å–±—Ä–æ—Å —Ñ–ª–∞–≥–∞
            try:
                self.ssh_client.disconnect()
            except:
                pass
            self.running = False
    
    def _run_nmap_scan(self):
        """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ Nmap —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"""
        self.add_log(LogLevel.INFO, "üîç –ó–∞–ø—É—Å–∫ Nmap —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...")
        self._set_step("nmap", "running")
        
        try:
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ö–æ—Å—Ç –∏–∑ URL
            host = self.target_url.replace("https://", "").replace("http://", "").split("/")[0]
            self.add_log(LogLevel.INFO, f"üì° –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ö–æ—Å—Ç–∞: {host}")
            
            # –ü–æ–ª–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤
            command = f"nmap -sS -sV -sC -A -p- {host} -oN /tmp/nmap_{self.pentest_id}.txt"
            self.add_log(LogLevel.INFO, f"‚öôÔ∏è –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã: nmap -sS -sV -sC -A -p- {host}")
            self.add_log(LogLevel.INFO, "‚è≥ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç...")
            exit_code, stdout, stderr = self.ssh_client.execute_command(command, timeout=1800)
            
            self.add_log(LogLevel.INFO, f"üìä Nmap –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –∫–æ–¥–æ–º: {exit_code}")
            
            if exit_code == 0:
                # –ß–∏—Ç–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                _, results, _ = self.ssh_client.execute_command(f"cat /tmp/nmap_{self.pentest_id}.txt")
                
                # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ Claude
                analysis = self.claude_client.analyze_scan_results(
                    "Nmap",
                    self.target_url,
                    results
                )
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º —É—è–∑–≤–∏–º–æ—Å—Ç–∏
                vulnerabilities = analysis.get("vulnerabilities", [])
                self._save_vulnerabilities(vulnerabilities)
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É—è–∑–≤–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ WebSocket
                for vuln in vulnerabilities:
                    try:
                        import asyncio
                        loop = asyncio.get_event_loop()
                        if loop.is_running():
                            asyncio.create_task(emit_pentest_vulnerability(self.pentest_id, vuln))
                        else:
                            loop.run_until_complete(emit_pentest_vulnerability(self.pentest_id, vuln))
                    except Exception as e:
                        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ WebSocket: {e}")
                
                self.add_log(LogLevel.INFO, f"‚úÖ Nmap: –Ω–∞–π–¥–µ–Ω–æ {len(vulnerabilities)} —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π")
                self._set_step("nmap", "completed")
            else:
                self.add_log(LogLevel.WARNING, f"‚ö†Ô∏è Nmap –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π: {stderr}")
                self._set_step("nmap", "failed")
                
        except Exception as e:
            self.add_log(LogLevel.ERROR, f"‚ùå –û—à–∏–±–∫–∞ Nmap: {str(e)}")
            self._set_step("nmap", "failed")
    
    def _run_nikto_scan(self):
        """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ Nikto —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"""
        self.add_log(LogLevel.INFO, "üîç –ó–∞–ø—É—Å–∫ Nikto —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...")
        
        try:
            command = f"nikto -h {self.target_url} -Format txt -output /tmp/nikto_{self.pentest_id}.txt"
            exit_code, stdout, stderr = self.ssh_client.execute_command(command, timeout=1800)
            
            if exit_code == 0 or exit_code == 1:  # Nikto –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 1 –ø—Ä–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö
                _, results, _ = self.ssh_client.execute_command(f"cat /tmp/nikto_{self.pentest_id}.txt")
                
                analysis = self.claude_client.analyze_scan_results(
                    "Nikto",
                    self.target_url,
                    results
                )
                
                vulnerabilities = analysis.get("vulnerabilities", [])
                self._save_vulnerabilities(vulnerabilities)
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É—è–∑–≤–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ WebSocket
                for vuln in vulnerabilities:
                    try:
                        import asyncio
                        loop = asyncio.get_event_loop()
                        if loop.is_running():
                            asyncio.create_task(emit_pentest_vulnerability(self.pentest_id, vuln))
                        else:
                            loop.run_until_complete(emit_pentest_vulnerability(self.pentest_id, vuln))
                    except Exception as e:
                        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ WebSocket: {e}")
                
                self.add_log(LogLevel.INFO, f"‚úÖ Nikto: –Ω–∞–π–¥–µ–Ω–æ {len(vulnerabilities)} —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π")
            else:
                self.add_log(LogLevel.WARNING, f"‚ö†Ô∏è Nikto –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π")
                
        except Exception as e:
            self.add_log(LogLevel.ERROR, f"‚ùå –û—à–∏–±–∫–∞ Nikto: {str(e)}")
    
    def _run_nuclei_scan(self):
        """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ Nuclei —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"""
        self.add_log(LogLevel.INFO, "üîç –ó–∞–ø—É—Å–∫ Nuclei —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...")
        
        try:
            # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑—ã Nuclei
            self.ssh_client.execute_command("nuclei -update-templates", timeout=300)
            
            command = f"nuclei -u {self.target_url} -o /tmp/nuclei_{self.pentest_id}.txt -json"
            exit_code, stdout, stderr = self.ssh_client.execute_command(command, timeout=1800)
            
            if exit_code == 0:
                _, results, _ = self.ssh_client.execute_command(f"cat /tmp/nuclei_{self.pentest_id}.txt")
                
                analysis = self.claude_client.analyze_scan_results(
                    "Nuclei",
                    self.target_url,
                    results
                )
                
                vulnerabilities = analysis.get("vulnerabilities", [])
                self._save_vulnerabilities(vulnerabilities)
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É—è–∑–≤–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ WebSocket
                for vuln in vulnerabilities:
                    try:
                        import asyncio
                        loop = asyncio.get_event_loop()
                        if loop.is_running():
                            asyncio.create_task(emit_pentest_vulnerability(self.pentest_id, vuln))
                        else:
                            loop.run_until_complete(emit_pentest_vulnerability(self.pentest_id, vuln))
                    except Exception as e:
                        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ WebSocket: {e}")
                
                self.add_log(LogLevel.INFO, f"‚úÖ Nuclei: –Ω–∞–π–¥–µ–Ω–æ {len(vulnerabilities)} —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π")
            else:
                self.add_log(LogLevel.WARNING, f"‚ö†Ô∏è Nuclei –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π")
                
        except Exception as e:
            self.add_log(LogLevel.ERROR, f"‚ùå –û—à–∏–±–∫–∞ Nuclei: {str(e)}")
    
    def _run_dirb_scan(self):
        """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ Dirb —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"""
        self.add_log(LogLevel.INFO, "üîç –ó–∞–ø—É—Å–∫ Dirb —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...")
        
        try:
            command = f"dirb {self.target_url} -o /tmp/dirb_{self.pentest_id}.txt"
            exit_code, stdout, stderr = self.ssh_client.execute_command(command, timeout=1800)
            
            if exit_code == 0:
                _, results, _ = self.ssh_client.execute_command(f"cat /tmp/dirb_{self.pentest_id}.txt")
                
                try:
                    analysis = self.claude_client.analyze_scan_results(
                        "Dirb",
                        self.target_url,
                        results
                    )
                    
                    vulnerabilities = analysis.get("vulnerabilities", [])
                    self._save_vulnerabilities(vulnerabilities)
                except Exception as api_error:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ Dirb —á–µ—Ä–µ–∑ Claude: {api_error}")
                    self.add_log(LogLevel.WARNING, f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —á–µ—Ä–µ–∑ Claude API: {str(api_error)}")
                    self.add_log(LogLevel.INFO, "–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–µ–Ω—Ç–µ—Å—Ç–∞ –±–µ–∑ –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ Dirb")
                    vulnerabilities = []
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É—è–∑–≤–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ WebSocket
                for vuln in vulnerabilities:
                    try:
                        import asyncio
                        loop = asyncio.get_event_loop()
                        if loop.is_running():
                            asyncio.create_task(emit_pentest_vulnerability(self.pentest_id, vuln))
                        else:
                            loop.run_until_complete(emit_pentest_vulnerability(self.pentest_id, vuln))
                    except Exception as e:
                        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ WebSocket: {e}")
                
                self.add_log(LogLevel.INFO, f"‚úÖ Dirb: –Ω–∞–π–¥–µ–Ω–æ {len(vulnerabilities)} —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π")
            else:
                self.add_log(LogLevel.WARNING, f"‚ö†Ô∏è Dirb –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π")
                
        except Exception as e:
            self.add_log(LogLevel.ERROR, f"‚ùå –û—à–∏–±–∫–∞ Dirb: {str(e)}")
    
    def _run_sqlmap_scan(self):
        """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQLMap —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"""
        self.add_log(LogLevel.INFO, "üîç –ó–∞–ø—É—Å–∫ SQLMap —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...")
        
        try:
            # SQLMap —Ç–æ–ª—å–∫–æ –¥–ª—è URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            if "?" in self.target_url:
                command = f"sqlmap -u '{self.target_url}' --batch --crawl=2 -o /tmp/sqlmap_{self.pentest_id}.txt"
                exit_code, stdout, stderr = self.ssh_client.execute_command(command, timeout=1800)
                
                if exit_code == 0:
                    _, results, _ = self.ssh_client.execute_command(f"cat /tmp/sqlmap_{self.pentest_id}.txt")
                    
                    analysis = self.claude_client.analyze_scan_results(
                        "SQLMap",
                        self.target_url,
                        results
                    )
                    
                    vulnerabilities = analysis.get("vulnerabilities", [])
                    self._save_vulnerabilities(vulnerabilities)
                    
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É—è–∑–≤–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ WebSocket
                    for vuln in vulnerabilities:
                        try:
                            import asyncio
                            loop = asyncio.get_event_loop()
                            if loop.is_running():
                                asyncio.create_task(emit_pentest_vulnerability(self.pentest_id, vuln))
                            else:
                                loop.run_until_complete(emit_pentest_vulnerability(self.pentest_id, vuln))
                        except Exception as e:
                            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ WebSocket: {e}")
                    
                    self.add_log(LogLevel.INFO, f"‚úÖ SQLMap: –Ω–∞–π–¥–µ–Ω–æ {len(vulnerabilities)} —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π")
                else:
                    self.add_log(LogLevel.WARNING, f"‚ö†Ô∏è SQLMap –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π")
            else:
                self.add_log(LogLevel.INFO, "‚è≠Ô∏è SQLMap –ø—Ä–æ–ø—É—â–µ–Ω (–Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ URL)")
                
        except Exception as e:
            self.add_log(LogLevel.ERROR, f"‚ùå –û—à–∏–±–∫–∞ SQLMap: {str(e)}")
    
    def _save_vulnerabilities(self, vulnerabilities: List[Dict[str, Any]]):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ –ë–î"""
        for vuln_data in vulnerabilities:
            try:
                vulnerability = Vulnerability(
                    pentest_id=self.pentest_id,
                    type=vuln_data.get("type", "Unknown"),
                    title=vuln_data.get("title", "Untitled"),
                    severity=Severity(vuln_data.get("severity", "low")),
                    description=vuln_data.get("description"),
                    location=vuln_data.get("location"),
                    cvss_score=vuln_data.get("cvss_score"),
                    exploit=vuln_data.get("exploit"),
                    recommendation=vuln_data.get("recommendation")
                )
                self.db.add(vulnerability)
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–∏: {e}")
        
        self.db.commit()

