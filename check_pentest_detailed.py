#!/usr/bin/env python3
"""
Детальная проверка пентеста
"""

import paramiko

SSH_HOST = "72.56.79.153"
SSH_USER = "root"
SSH_PASSWORD = "m8J@2_6whwza6U"

def main():
    print("="*60)
    print("ДЕТАЛЬНАЯ ПРОВЕРКА ПЕНТЕСТА")
    print("="*60)
    
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(SSH_HOST, username=SSH_USER, password=SSH_PASSWORD, timeout=30)
    
    try:
        # 1. Проверяем содержимое файла nmap
        print("\n1. СОДЕРЖИМОЕ ФАЙЛА NMAP:")
        stdin, stdout, stderr = ssh.exec_command("cat /tmp/nmap_1.txt 2>&1")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output[:2000] if output else "Файл пуст или не найден")
        
        # 2. Проверяем логи в базе данных более детально
        print("\n2. ВСЕ ЛОГИ ПЕНТЕСТА:")
        stdin, stdout, stderr = ssh.exec_command("""
cd /root/shannon/backend && python3 << 'PYEOF'
from app.database import SessionLocal
from app.models.log import Log

db = SessionLocal()
logs = db.query(Log).filter(Log.pentest_id == 1).order_by(Log.timestamp).all()
print(f"Всего логов: {len(logs)}")
for log in logs:
    print(f"[{log.timestamp}] [{log.level}] {log.message}")
PYEOF
""")
        output = stdout.read().decode('utf-8', errors='replace')
        try:
            print(output if output else "Логи не найдены")
        except:
            print((output if output else "Логи не найдены").encode('ascii', 'replace').decode('ascii'))
        
        # 3. Проверяем статус процесса nmap
        print("\n3. СТАТУС ПРОЦЕССА NMAP:")
        stdin, stdout, stderr = ssh.exec_command("ps aux | grep nmap | grep -v grep")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output if output else "Процесс nmap не найден")
        
        # 4. Проверяем логи Python приложения (более детально)
        print("\n4. ПОЛНЫЕ ЛОГИ BACKEND (последние 50 строк):")
        stdin, stdout, stderr = ssh.exec_command("tail -50 /tmp/shannon-backend.log 2>&1")
        output = stdout.read().decode('utf-8', errors='replace')
        try:
            print(output[:3000])
        except:
            print(output[:3000].encode('ascii', 'replace').decode('ascii'))
        
        # 5. Проверяем код PentestEngine - как он добавляет логи
        print("\n5. ПРОВЕРКА КОДА ДОБАВЛЕНИЯ ЛОГОВ:")
        stdin, stdout, stderr = ssh.exec_command("grep -n 'add_log\\|LogLevel' /root/shannon/backend/app/core/pentest_engine.py | head -20")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output if output else "Не найдено")
        
    finally:
        ssh.close()

if __name__ == "__main__":
    main()

