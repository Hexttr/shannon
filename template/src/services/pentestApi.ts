import api from './api';
import { Pentest, CreatePentestRequest, PentestStatusResponse, Vulnerability, Log } from '../types';
import { normalizePentest, normalizeVulnerability, normalizeLog } from '../utils/normalize';

export const pentestApi = {
  getAll: async (): Promise<{ data: Pentest[] }> => {
    const response = await api.get<Pentest[]>('/api/pentests');
    return { data: response.data.map(normalizePentest) };
  },

  getById: async (id: number): Promise<{ data: Pentest }> => {
    const response = await api.get<Pentest>(`/api/pentests/${id}`);
    return { data: normalizePentest(response.data) };
  },

  create: async (data: CreatePentestRequest): Promise<{ data: Pentest }> => {
    // Преобразуем camelCase в snake_case для backend
    const backendData = {
      name: data.name,
      target_url: data.target_url || (data.config as any)?.targetUrl,
      config: data.config,
    };
    const response = await api.post<Pentest>('/api/pentests', backendData);
    return { data: normalizePentest(response.data) };
  },

  start: async (id: number): Promise<void> => {
    return api.post(`/api/pentests/${id}/start`);
  },

  stop: async (id: number): Promise<void> => {
    return api.post(`/api/pentests/${id}/stop`);
  },

  getStatus: async (id: number): Promise<{ data: PentestStatusResponse }> => {
    return api.get<PentestStatusResponse>(`/api/pentests/${id}/status`);
  },

  getVulnerabilities: async (id: number): Promise<{ data: Vulnerability[] }> => {
    const response = await api.get<Vulnerability[]>(`/api/pentests/${id}/vulnerabilities`);
    return { data: response.data.map(normalizeVulnerability) };
  },

  getLogs: async (id: number): Promise<{ data: Log[] }> => {
    const response = await api.get<Log[]>(`/api/pentests/${id}/logs`);
    return { data: response.data.map(normalizeLog) };
  },

  delete: async (id: number): Promise<void> => {
    return api.delete(`/api/pentests/${id}`);
  },

  generateReport: async (id: number): Promise<{ data: { message: string; markdown_path: string } }> => {
    return api.post(`/api/pentests/${id}/reports`);
  },

  checkReportExists: async (id: number): Promise<{ data: { exists: boolean } }> => {
    return api.get<{ exists: boolean }>(`/api/pentests/${id}/reports/check`);
  },

  generatePdfReport: async (id: number): Promise<Blob> => {
    const response = await api.get(`/api/pentests/${id}/reports/pdf`, {
      responseType: 'blob',
    });
    return response.data;
  },
};


