#!/usr/bin/env python3
"""
Проверка статуса пентеста и workflow
"""

import paramiko
import json

SSH_HOST = "72.56.79.153"
SSH_USER = "root"
SSH_PASSWORD = "m8J@2_6whwza6U"

def main():
    print("="*60)
    print("ПРОВЕРКА СТАТУСА ПЕНТЕСТА И WORKFLOW")
    print("="*60)
    
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(SSH_HOST, username=SSH_USER, password=SSH_PASSWORD, timeout=30)
    
    try:
        # 1. Все пентесты
        print("\n1. ВСЕ ПЕНТЕСТЫ:")
        stdin, stdout, stderr = ssh.exec_command("sqlite3 /root/shannon/backend/shannon.db 'SELECT id, name, target_url, status, current_step, started_at, completed_at FROM pentests ORDER BY created_at DESC LIMIT 5;'")
        all_pentests = stdout.read().decode('utf-8', errors='replace')
        if all_pentests:
            print("  Последние 5 пентестов:")
            for line in all_pentests.strip().split('\n'):
                if line:
                    parts = line.split('|')
                    if len(parts) >= 7:
                        pid, name, target, status, step, started, completed = parts[0], parts[1], parts[2], parts[3], parts[4], parts[5], parts[6]
                        print(f"    ID: {pid}, Имя: {name[:30]}, Статус: {status}, Шаг: {step}")
                        print(f"      Цель: {target[:50]}")
                        print(f"      Запущен: {started if started != 'None' else 'нет'}")
                        print(f"      Завершен: {completed if completed != 'None' else 'нет'}")
        else:
            print("  [INFO] Пентесты не найдены")
        
        # 2. Активные пентесты
        print("\n2. АКТИВНЫЕ ПЕНТЕСТЫ (RUNNING):")
        stdin, stdout, stderr = ssh.exec_command("sqlite3 /root/shannon/backend/shannon.db 'SELECT id, name, current_step, step_progress FROM pentests WHERE status = \"RUNNING\" ORDER BY created_at DESC;'")
        running = stdout.read().decode('utf-8', errors='replace')
        if running:
            print("  Найдены активные пентесты:")
            for line in running.strip().split('\n'):
                if line:
                    parts = line.split('|')
                    if len(parts) >= 4:
                        pid, name, step, progress = parts[0], parts[1], parts[2], parts[3]
                        print(f"    ID: {pid}, Имя: {name[:30]}")
                        print(f"      Текущий шаг: {step if step else 'не установлен'}")
                        print(f"      Прогресс: {progress[:100] if progress else 'не установлен'}")
        else:
            print("  [INFO] Активных пентестов нет")
        
        # 3. Последний пентест
        print("\n3. ПОСЛЕДНИЙ ПЕНТЕСТ:")
        stdin, stdout, stderr = ssh.exec_command("sqlite3 /root/shannon/backend/shannon.db 'SELECT id, name, status, current_step, step_progress, started_at, completed_at FROM pentests ORDER BY created_at DESC LIMIT 1;'")
        last = stdout.read().decode('utf-8', errors='replace')
        if last:
            parts = last.strip().split('|')
            if len(parts) >= 7:
                pid, name, status, step, progress, started, completed = parts[0], parts[1], parts[2], parts[3], parts[4], parts[5], parts[6]
                print(f"  ID: {pid}")
                print(f"  Имя: {name}")
                print(f"  Статус: {status}")
                print(f"  Текущий шаг: {step if step else 'не установлен'}")
                print(f"  Прогресс: {progress[:200] if progress else 'не установлен'}")
                print(f"  Запущен: {started if started != 'None' else 'не запущен'}")
                print(f"  Завершен: {completed if completed != 'None' else 'в процессе'}")
                
                # Парсим step_progress если есть
                if progress and progress != 'None':
                    try:
                        progress_dict = json.loads(progress)
                        print(f"\n  Детали прогресса:")
                        for step_name, step_status in progress_dict.items():
                            print(f"    {step_name}: {step_status}")
                    except:
                        pass
            else:
                print(f"  {last}")
        else:
            print("  [INFO] Пентесты не найдены")
        
        # 4. Процессы сканирования
        print("\n4. ПРОЦЕССЫ СКАНИРОВАНИЯ:")
        tools = ["nmap", "nikto", "nuclei", "dirb", "sqlmap"]
        active_tools = []
        for tool in tools:
            stdin, stdout, stderr = ssh.exec_command(f"ps aux | grep {tool} | grep -v grep | wc -l")
            count = int(stdout.read().decode('utf-8', errors='replace').strip() or 0)
            if count > 0:
                active_tools.append(tool)
                print(f"  [ACTIVE] {tool}: {count} процесс(ов)")
        
        if not active_tools:
            print("  [INFO] Нет активных процессов сканирования")
        
        # 5. Последние логи
        print("\n5. ПОСЛЕДНИЕ ЛОГИ (последний пентест):")
        if last:
            pid = parts[0]
            stdin, stdout, stderr = ssh.exec_command(f"sqlite3 /root/shannon/backend/shannon.db 'SELECT timestamp, level, message FROM logs WHERE pentest_id = {pid} ORDER BY timestamp DESC LIMIT 10;'")
            logs = stdout.read().decode('utf-8', errors='replace')
            if logs:
                print("  Последние 10 логов:")
                for log in logs.strip().split('\n')[:10]:
                    if log:
                        safe_log = log.encode('ascii', 'replace').decode('ascii')
                        print(f"    {safe_log[:150]}")
        
        # 6. Уязвимости
        print("\n6. НАЙДЕННЫЕ УЯЗВИМОСТИ:")
        if last:
            pid = parts[0]
            stdin, stdout, stderr = ssh.exec_command(f"sqlite3 /root/shannon/backend/shannon.db 'SELECT COUNT(*) FROM vulnerabilities WHERE pentest_id = {pid};'")
            vuln_count = stdout.read().decode('utf-8', errors='replace').strip()
            print(f"  Всего найдено: {vuln_count}")
        
        print("\n" + "="*60)
        print("ВЫВОД")
        print("="*60)
        
        if running:
            print("\n[INFO] Есть активные пентесты (RUNNING)")
            print("Workflow активен")
        elif last:
            status = parts[2] if len(parts) > 2 else "unknown"
            if status == "COMPLETED":
                print("\n[INFO] Последний пентест завершен (COMPLETED)")
                print("Workflow завершен")
            elif status == "FAILED":
                print("\n[INFO] Последний пентест завершился с ошибкой (FAILED)")
                print("Workflow завершен с ошибкой")
            elif status == "STOPPED":
                print("\n[INFO] Последний пентест остановлен (STOPPED)")
                print("Workflow остановлен")
            else:
                print(f"\n[INFO] Статус последнего пентеста: {status}")
        else:
            print("\n[INFO] Пентесты не найдены")
            print("Workflow не активен")
        
    finally:
        ssh.close()

if __name__ == "__main__":
    main()

