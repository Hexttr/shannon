#!/usr/bin/env python3
"""
Полная проверка статуса пентеста
"""

import paramiko
from datetime import datetime

SSH_HOST = "72.56.79.153"
SSH_USER = "root"
SSH_PASSWORD = "m8J@2_6whwza6U"

def main():
    print("="*60)
    print("СТАТУС ВЫПОЛНЕНИЯ ПЕНТЕСТА")
    print("="*60)
    
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(SSH_HOST, username=SSH_USER, password=SSH_PASSWORD, timeout=30)
    
    try:
        # 1. Основная информация о пентесте
        print("\n1. ОСНОВНАЯ ИНФОРМАЦИЯ:")
        stdin, stdout, stderr = ssh.exec_command("sqlite3 /root/shannon/backend/shannon.db 'SELECT id, name, target_url, status, current_step, started_at, completed_at FROM pentests ORDER BY created_at DESC LIMIT 1;'")
        output = stdout.read().decode('utf-8', errors='replace')
        if output:
            parts = output.strip().split('|')
            if len(parts) >= 7:
                pentest_id, name, target_url, status, current_step, started_at, completed_at = parts[0], parts[1], parts[2], parts[3], parts[4], parts[5], parts[6]
                print(f"  ID: {pentest_id}")
                print(f"  Имя: {name}")
                print(f"  Цель: {target_url}")
                print(f"  Статус: {status}")
                print(f"  Текущий шаг: {current_step if current_step else 'не установлен'}")
                print(f"  Запущен: {started_at if started_at else 'не запущен'}")
                print(f"  Завершен: {completed_at if completed_at else 'в процессе'}")
                
                # Вычисляем время работы
                if started_at and started_at != 'None':
                    try:
                        start_time = datetime.fromisoformat(started_at.replace(' ', 'T'))
                        now = datetime.now()
                        elapsed = now - start_time
                        hours = elapsed.seconds // 3600
                        minutes = (elapsed.seconds % 3600) // 60
                        seconds = elapsed.seconds % 60
                        print(f"  Время работы: {hours}ч {minutes}м {seconds}с")
                    except:
                        pass
            else:
                print(f"  {output}")
        else:
            print("  Пентесты не найдены")
            return
        
        # 2. Прогресс workflow
        print("\n2. ПРОГРЕСС WORKFLOW:")
        stdin, stdout, stderr = ssh.exec_command(f"sqlite3 /root/shannon/backend/shannon.db 'SELECT step_progress FROM pentests WHERE id = {pentest_id};'")
        step_progress = stdout.read().decode('utf-8', errors='replace').strip()
        if step_progress:
            print(f"  {step_progress}")
        else:
            print("  Прогресс не установлен")
        
        # 3. Активные процессы сканирования
        print("\n3. АКТИВНЫЕ ПРОЦЕССЫ:")
        tools = ["nmap", "nikto", "nuclei", "dirb", "sqlmap", "gobuster"]
        active_count = 0
        for tool in tools:
            stdin, stdout, stderr = ssh.exec_command(f"ps aux | grep {tool} | grep -v grep | wc -l")
            count = int(stdout.read().decode('utf-8', errors='replace').strip() or 0)
            if count > 0:
                active_count += count
                # Получаем детали процесса
                stdin, stdout, stderr = ssh.exec_command(f"ps aux | grep {tool} | grep -v grep | head -1")
                proc_info = stdout.read().decode('utf-8', errors='replace').strip()
                if proc_info:
                    # Извлекаем время работы
                    import re
                    time_match = re.search(r'(\d+):(\d+)', proc_info)
                    if time_match:
                        minutes = int(time_match.group(1))
                        seconds = int(time_match.group(2))
                        print(f"  [ACTIVE] {tool}: {count} процесс(ов), время работы: {minutes}м {seconds}с")
                    else:
                        print(f"  [ACTIVE] {tool}: {count} процесс(ов)")
        
        if active_count == 0:
            print("  [INFO] Нет активных процессов сканирования")
        
        # 4. Последние логи
        print("\n4. ПОСЛЕДНИЕ 15 ЛОГОВ:")
        stdin, stdout, stderr = ssh.exec_command(f"sqlite3 /root/shannon/backend/shannon.db 'SELECT timestamp, level, message FROM logs WHERE pentest_id = {pentest_id} ORDER BY timestamp DESC LIMIT 15;'")
        logs = stdout.read().decode('utf-8', errors='replace')
        if logs:
            for i, log in enumerate(logs.strip().split('\n')[:15], 1):
                if log:
                    safe_log = log.encode('ascii', 'replace').decode('ascii')
                    # Выделяем ошибки
                    if 'ERROR' in log.upper() or 'FAILED' in log.upper():
                        print(f"  [{i}] [ERROR] {safe_log[:150]}")
                    elif 'WARNING' in log.upper():
                        print(f"  [{i}] [WARN] {safe_log[:150]}")
                    else:
                        print(f"  [{i}] {safe_log[:150]}")
        else:
            print("  Логи не найдены")
        
        # 5. Найденные уязвимости
        print("\n5. НАЙДЕННЫЕ УЯЗВИМОСТИ:")
        stdin, stdout, stderr = ssh.exec_command(f"sqlite3 /root/shannon/backend/shannon.db 'SELECT COUNT(*) FROM vulnerabilities WHERE pentest_id = {pentest_id};'")
        vuln_count = stdout.read().decode('utf-8', errors='replace').strip()
        print(f"  Всего найдено: {vuln_count}")
        
        if int(vuln_count or 0) > 0:
            stdin, stdout, stderr = ssh.exec_command(f"sqlite3 /root/shannon/backend/shannon.db 'SELECT type, title, severity FROM vulnerabilities WHERE pentest_id = {pentest_id} ORDER BY created_at DESC LIMIT 10;'")
            vulns = stdout.read().decode('utf-8', errors='replace')
            if vulns:
                print("  Последние:")
                for vuln in vulns.strip().split('\n')[:10]:
                    if vuln:
                        safe_vuln = vuln.encode('ascii', 'replace').decode('ascii')
                        print(f"    - {safe_vuln[:120]}")
        
        # 6. Статистика по шагам
        print("\n6. СТАТИСТИКА ПО ШАГАМ:")
        steps = ["nmap", "nikto", "nuclei", "dirb", "sqlmap"]
        for step in steps:
            stdin, stdout, stderr = ssh.exec_command(f"sqlite3 /root/shannon/backend/shannon.db 'SELECT COUNT(*) FROM logs WHERE pentest_id = {pentest_id} AND message LIKE \"%{step}%\" AND (message LIKE \"%completed%\" OR message LIKE \"%заверш%\" OR message LIKE \"%найдено%\");'")
            step_logs = stdout.read().decode('utf-8', errors='replace').strip()
            if step_logs and int(step_logs) > 0:
                print(f"  {step.upper()}: выполнено")
            else:
                if current_step == step:
                    print(f"  {step.upper()}: [В ПРОЦЕССЕ]")
                else:
                    print(f"  {step.upper()}: ожидание")
        
        # 7. Проверка ошибок
        print("\n7. ОШИБКИ:")
        stdin, stdout, stderr = ssh.exec_command(f"sqlite3 /root/shannon/backend/shannon.db 'SELECT COUNT(*) FROM logs WHERE pentest_id = {pentest_id} AND level = \"ERROR\";'")
        error_count = stdout.read().decode('utf-8', errors='replace').strip()
        if int(error_count or 0) > 0:
            print(f"  Найдено ошибок: {error_count}")
            stdin, stdout, stderr = ssh.exec_command(f"sqlite3 /root/shannon/backend/shannon.db 'SELECT message FROM logs WHERE pentest_id = {pentest_id} AND level = \"ERROR\" ORDER BY timestamp DESC LIMIT 3;'")
            errors = stdout.read().decode('utf-8', errors='replace')
            if errors:
                for err in errors.strip().split('\n')[:3]:
                    if err:
                        safe_err = err.encode('ascii', 'replace').decode('ascii')
                        print(f"    - {safe_err[:150]}")
        else:
            print("  [OK] Ошибок не найдено")
        
        print("\n" + "="*60)
        print("ИТОГ")
        print("="*60)
        
        if status == "RUNNING":
            print(f"\n[INFO] Пентест выполняется")
            print(f"Текущий шаг: {current_step}")
            if active_count > 0:
                print(f"Активных процессов: {active_count}")
            else:
                print("[WARNING] Нет активных процессов - возможно пентест завис")
        elif status == "COMPLETED":
            print("\n[SUCCESS] Пентест завершен успешно")
        elif status == "FAILED":
            print("\n[ERROR] Пентест завершился с ошибкой")
        else:
            print(f"\n[INFO] Статус: {status}")
        
    finally:
        ssh.close()

if __name__ == "__main__":
    main()

