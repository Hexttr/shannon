<?php

namespace App\Http\Controllers\Api;

use App\Data\Pentests\CreatePentestData;
use App\Domain\Pentests\Actions\CreatePentestAction;
use App\Domain\Pentests\Actions\DeletePentestAction;
use App\Domain\Pentests\Actions\GetAllPentestsAction;
use App\Domain\Pentests\Actions\StartPentestAction;
use App\Domain\Pentests\Actions\StopPentestAction;
use App\Http\Controllers\Controller;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;

class PentestController extends Controller
{
    public function __construct(
        private GetAllPentestsAction $getAllPentestsAction,
        private CreatePentestAction $createPentestAction,
        private StartPentestAction $startPentestAction,
        private StopPentestAction $stopPentestAction,
        private DeletePentestAction $deletePentestAction
    ) {
    }

    public function index(): JsonResponse
    {
        $pentests = $this->getAllPentestsAction->execute();

        return response()->json([
            'data' => $pentests->map(fn ($pentest) => $pentest->toArray())->values(),
        ]);
    }

    public function store(Request $request): JsonResponse
    {
        $data = CreatePentestData::from($request->all());
        $pentest = $this->createPentestAction->execute($data);

        return response()->json([
            'data' => $pentest->toArray(),
        ], 201);
    }

    public function start(string $id): JsonResponse
    {
        $this->startPentestAction->execute($id);

        return response()->json(['message' => 'Пентест запущен']);
    }

    public function stop(string $id): JsonResponse
    {
        $this->stopPentestAction->execute($id);

        return response()->json(['message' => 'Пентест остановлен']);
    }

    public function destroy(string $id): JsonResponse
    {
        $this->deletePentestAction->execute($id);

        return response()->json(null, 204);
    }
}

