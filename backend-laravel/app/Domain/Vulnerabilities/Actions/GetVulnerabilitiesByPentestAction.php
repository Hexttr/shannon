<?php

namespace App\Domain\Vulnerabilities\Actions;

use App\Data\Vulnerabilities\VulnerabilityData;
use App\Models\Pentest;
use Illuminate\Support\Collection;

class GetVulnerabilitiesByPentestAction
{
    /**
     * @return Collection<int, VulnerabilityData>
     */
    public function execute(string $pentestId): Collection
    {
        $pentest = Pentest::findOrFail($pentestId);

        return $pentest->vulnerabilities()
            ->orderBy('created_at', 'desc')
            ->get()
            ->map(fn ($vuln) => VulnerabilityData::from([
                'id' => $vuln->id,
                'pentest_id' => $vuln->pentest_id,
                'title' => $vuln->title,
                'description' => $vuln->description,
                'severity' => $vuln->severity,
                'cvss_score' => $vuln->cvss_score,
                'cve' => $vuln->cve,
                'solution' => $vuln->solution,
                'created_at' => $vuln->created_at->toISOString(),
            ]));
    }
}

