#!/usr/bin/env python3
"""
Проверка API пентестов и почему они не отображаются во фронте
"""

import paramiko
import json

SSH_HOST = "72.56.79.153"
SSH_USER = "root"
SSH_PASSWORD = "m8J@2_6whwza6U"

def main():
    print("="*60)
    print("ПРОВЕРКА API ПЕНТЕСТОВ")
    print("="*60)
    
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(SSH_HOST, username=SSH_USER, password=SSH_PASSWORD, timeout=30)
    
    try:
        # 1. Проверяем пентесты в БД
        print("\n1. ПЕНТЕСТЫ В БАЗЕ ДАННЫХ:")
        stdin, stdout, stderr = ssh.exec_command("sqlite3 /root/shannon/backend/shannon.db 'SELECT id, name, status, created_at FROM pentests ORDER BY created_at DESC;'")
        db_pentests = stdout.read().decode('utf-8', errors='replace')
        if db_pentests:
            print("  Все пентесты в БД:")
            for line in db_pentests.strip().split('\n'):
                if line:
                    parts = line.split('|')
                    if len(parts) >= 4:
                        pid, name, status, created = parts[0], parts[1], parts[2], parts[3]
                        print(f"    ID: {pid}, Имя: {name[:40]}, Статус: {status}, Создан: {created}")
        else:
            print("  [ERROR] Пентесты не найдены в БД!")
        
        # 2. Тестируем API напрямую (без авторизации сначала)
        print("\n2. ТЕСТ API БЕЗ АВТОРИЗАЦИИ:")
        stdin, stdout, stderr = ssh.exec_command("curl -s http://localhost:8000/api/pentests 2>&1")
        api_no_auth = stdout.read().decode('utf-8', errors='replace')
        print(f"  Ответ: {api_no_auth[:300]}")
        
        # 3. Получаем токен
        print("\n3. ПОЛУЧЕНИЕ ТОКЕНА:")
        stdin, stdout, stderr = ssh.exec_command("curl -s -X POST http://localhost:8000/api/auth/login -H 'Content-Type: application/json' -d '{\"username\":\"admin\",\"password\":\"513277\"}' 2>&1")
        login_response = stdout.read().decode('utf-8', errors='replace')
        print(f"  Ответ: {login_response[:300]}")
        
        # Извлекаем токен
        token = None
        if 'access_token' in login_response:
            try:
                login_data = json.loads(login_response)
                token = login_data.get('access_token')
                print(f"  [OK] Токен получен: {token[:50]}...")
            except:
                print("  [ERROR] Не удалось распарсить ответ")
        else:
            print("  [ERROR] Токен не получен")
            return
        
        # 4. Тестируем API с токеном
        print("\n4. ТЕСТ API С ТОКЕНОМ:")
        stdin, stdout, stderr = ssh.exec_command(f"curl -s -H 'Authorization: Bearer {token}' http://localhost:8000/api/pentests 2>&1")
        api_with_auth = stdout.read().decode('utf-8', errors='replace')
        print(f"  Ответ API: {api_with_auth[:500]}")
        
        # Парсим ответ
        if api_with_auth:
            try:
                pentests_data = json.loads(api_with_auth)
                if isinstance(pentests_data, list):
                    print(f"\n  [OK] Получено пентестов: {len(pentests_data)}")
                    for p in pentests_data[:3]:
                        if isinstance(p, dict):
                            print(f"    ID: {p.get('id')}, Имя: {p.get('name', '')[:30]}, Статус: {p.get('status')}")
                elif isinstance(pentests_data, dict):
                    print(f"\n  Ответ в формате объекта: {pentests_data}")
            except json.JSONDecodeError:
                print(f"  [ERROR] Не удалось распарсить JSON: {api_with_auth[:200]}")
        
        # 5. Проверяем структуру ответа
        print("\n5. СТРУКТУРА ОТВЕТА:")
        if api_with_auth:
            try:
                data = json.loads(api_with_auth)
                print(f"  Тип: {type(data)}")
                if isinstance(data, dict):
                    print(f"  Ключи: {list(data.keys())}")
                    if 'data' in data:
                        print(f"  data: {data['data']}")
            except:
                pass
        
        # 6. Проверяем код API endpoint
        print("\n6. ПРОВЕРКА КОДА API:")
        stdin, stdout, stderr = ssh.exec_command("grep -A 20 'def.*get.*pentests' /root/shannon/backend/app/api/pentests.py | head -25")
        api_code = stdout.read().decode('utf-8', errors='replace')
        if api_code:
            print("  Код endpoint:")
            print(api_code[:500])
        
        # 7. Проверяем логи backend на ошибки
        print("\n7. ЛОГИ BACKEND (последние запросы):")
        stdin, stdout, stderr = ssh.exec_command("tail -20 /var/log/shannon-backend.log 2>/dev/null | grep -E 'pentests|GET.*api'")
        backend_logs = stdout.read().decode('utf-8', errors='replace')
        if backend_logs:
            print("  Последние запросы:")
            for line in backend_logs.strip().split('\n')[-10:]:
                if line:
                    safe_line = line.encode('ascii', 'replace').decode('ascii')
                    print(f"    {safe_line[:150]}")
        
        print("\n" + "="*60)
        print("АНАЛИЗ")
        print("="*60)
        
        if db_pentests and not api_with_auth:
            print("\n[ERROR] Пентесты есть в БД, но API не возвращает их")
            print("Возможные причины:")
            print("  1. Проблема с авторизацией")
            print("  2. Ошибка в коде API endpoint")
            print("  3. Фильтрация по статусу")
        elif api_with_auth:
            try:
                data = json.loads(api_with_auth)
                if isinstance(data, list) and len(data) == 0:
                    print("\n[WARNING] API возвращает пустой список")
                    print("Пентесты есть в БД, но не возвращаются через API")
                elif isinstance(data, list) and len(data) > 0:
                    print(f"\n[OK] API возвращает {len(data)} пентестов")
                else:
                    print(f"\n[INFO] API возвращает: {type(data)}")
            except:
                print("\n[ERROR] Не удалось проанализировать ответ API")
        
    finally:
        ssh.close()

if __name__ == "__main__":
    main()

