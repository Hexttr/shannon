#!/usr/bin/env python3
"""
Проверка пентеста через SQL
"""

import paramiko

SSH_HOST = "72.56.79.153"
SSH_USER = "root"
SSH_PASSWORD = "m8J@2_6whwza6U"

def main():
    print("="*60)
    print("ПРОВЕРКА ПЕНТЕСТА ЧЕРЕЗ SQL")
    print("="*60)
    
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(SSH_HOST, username=SSH_USER, password=SSH_PASSWORD, timeout=30)
    
    try:
        # Проверяем через SQLite напрямую
        print("\n1. СТАТУС ПЕНТЕСТА:")
        stdin, stdout, stderr = ssh.exec_command("sqlite3 /root/shannon/backend/shannon.db 'SELECT id, name, target_url, status, created_at, started_at, completed_at FROM pentests ORDER BY created_at DESC LIMIT 1;'")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output if output else "Пентесты не найдены")
        
        # Проверяем логи
        print("\n2. КОЛИЧЕСТВО ЛОГОВ:")
        stdin, stdout, stderr = ssh.exec_command("sqlite3 /root/shannon/backend/shannon.db 'SELECT COUNT(*) FROM logs WHERE pentest_id = 1;'")
        output = stdout.read().decode('utf-8', errors='replace')
        print(f"Логов для пентеста ID=1: {output.strip()}")
        
        # Последние логи
        print("\n3. ПОСЛЕДНИЕ ЛОГИ:")
        stdin, stdout, stderr = ssh.exec_command("sqlite3 /root/shannon/backend/shannon.db 'SELECT timestamp, level, message FROM logs WHERE pentest_id = 1 ORDER BY timestamp DESC LIMIT 10;'")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output if output else "Логи не найдены")
        
        # Проверяем уязвимости
        print("\n4. УЯЗВИМОСТИ:")
        stdin, stdout, stderr = ssh.exec_command("sqlite3 /root/shannon/backend/shannon.db 'SELECT COUNT(*) FROM vulnerabilities WHERE pentest_id = 1;'")
        output = stdout.read().decode('utf-8', errors='replace')
        print(f"Уязвимостей: {output.strip()}")
        
        # Проверяем содержимое файла nmap
        print("\n5. СОДЕРЖИМОЕ ФАЙЛА NMAP (последние 30 строк):")
        stdin, stdout, stderr = ssh.exec_command("tail -30 /tmp/nmap_1.txt 2>&1")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output[:1500] if output else "Файл пуст")
        
        # Проверяем нагрузку еще раз
        print("\n6. ТЕКУЩАЯ НАГРУЗКА:")
        stdin, stdout, stderr = ssh.exec_command("uptime && echo '---' && free -h")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output)
        
    finally:
        ssh.close()

if __name__ == "__main__":
    main()

