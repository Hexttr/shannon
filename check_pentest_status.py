#!/usr/bin/env python3
"""
Проверка статуса пентеста и логов
"""

import paramiko
import json

SSH_HOST = "72.56.79.153"
SSH_USER = "root"
SSH_PASSWORD = "m8J@2_6whwza6U"

def main():
    print("="*60)
    print("ПРОВЕРКА СТАТУСА ПЕНТЕСТА")
    print("="*60)
    
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(SSH_HOST, username=SSH_USER, password=SSH_PASSWORD, timeout=30)
    
    try:
        # 1. Проверяем пентесты в базе данных
        print("\n1. ПЕНТЕСТЫ В БАЗЕ ДАННЫХ:")
        stdin, stdout, stderr = ssh.exec_command("""
cd /root/shannon/backend && python3 << 'PYEOF'
from app.database import SessionLocal
from app.models.pentest import Pentest, PentestStatus
from datetime import datetime

db = SessionLocal()
pentests = db.query(Pentest).order_by(Pentest.created_at.desc()).limit(5).all()

for p in pentests:
    print(f"ID: {p.id}")
    print(f"  Название: {p.name}")
    print(f"  URL: {p.target_url}")
    print(f"  Статус: {p.status.value if hasattr(p.status, 'value') else p.status}")
    print(f"  Создан: {p.created_at}")
    print(f"  Запущен: {p.started_at if p.started_at else 'Нет'}")
    print(f"  Завершен: {p.completed_at if p.completed_at else 'Нет'}")
    print()
PYEOF
""")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output)
        
        # 2. Проверяем логи пентеста
        print("\n2. ЛОГИ ПЕНТЕСТА:")
        stdin, stdout, stderr = ssh.exec_command("""
cd /root/shannon/backend && python3 << 'PYEOF'
from app.database import SessionLocal
from app.models.pentest import Pentest
from app.models.log import Log

db = SessionLocal()
# Получаем последний пентест
pentest = db.query(Pentest).order_by(Pentest.created_at.desc()).first()

if pentest:
    print(f"Пентест ID: {pentest.id}, Статус: {pentest.status.value if hasattr(pentest.status, 'value') else pentest.status}")
    logs = db.query(Log).filter(Log.pentest_id == pentest.id).order_by(Log.timestamp.desc()).limit(20).all()
    print(f"\nПоследние {len(logs)} логов:")
    for log in reversed(logs):
        print(f"[{log.timestamp}] [{log.level.upper()}] {log.message}")
else:
    print("Пентесты не найдены")
PYEOF
""")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output)
        
        # 3. Проверяем уязвимости
        print("\n3. УЯЗВИМОСТИ:")
        stdin, stdout, stderr = ssh.exec_command("""
cd /root/shannon/backend && python3 << 'PYEOF'
from app.database import SessionLocal
from app.models.pentest import Pentest
from app.models.vulnerability import Vulnerability

db = SessionLocal()
pentest = db.query(Pentest).order_by(Pentest.created_at.desc()).first()

if pentest:
    vulns = db.query(Vulnerability).filter(Vulnerability.pentest_id == pentest.id).all()
    print(f"Найдено уязвимостей: {len(vulns)}")
    for v in vulns[:10]:
        print(f"  - {v.severity.value if hasattr(v.severity, 'value') else v.severity}: {v.title}")
else:
    print("Пентесты не найдены")
PYEOF
""")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output)
        
        # 4. Проверяем процессы Python
        print("\n4. ПРОЦЕССЫ PYTHON:")
        stdin, stdout, stderr = ssh.exec_command("ps aux | grep -E 'python|nmap|nikto|nuclei|sqlmap|dirb|gobuster|wpscan|whatweb|subfinder|httpx' | grep -v grep | head -20")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output if output else "Нет активных процессов")
        
        # 5. Проверяем логи backend
        print("\n5. ПОСЛЕДНИЕ ЛОГИ BACKEND:")
        stdin, stdout, stderr = ssh.exec_command("tail -100 /tmp/shannon-backend.log 2>&1 | grep -E 'pentest|Pentest|ERROR|WARNING|INFO.*пентест' | tail -30")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output if output else "Нет релевантных логов")
        
        # 6. Проверяем временные файлы пентеста
        print("\n6. ВРЕМЕННЫЕ ФАЙЛЫ ПЕНТЕСТА:")
        stdin, stdout, stderr = ssh.exec_command("ls -lah /tmp/nmap_*.txt /tmp/nikto_*.txt /tmp/nuclei_*.txt /tmp/dirb_*.txt /tmp/sqlmap_*.txt 2>&1 | tail -10")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output if output else "Временные файлы не найдены")
        
        # 7. Проверяем подключение SSH к серверу
        print("\n7. ПРОВЕРКА SSH КЛИЕНТА:")
        stdin, stdout, stderr = ssh.exec_command("""
cd /root/shannon/backend && python3 << 'PYEOF'
from app.core.ssh_client import SSHClient

ssh = SSHClient()
if ssh.connect():
    print("SSH подключение работает")
    ssh.disconnect()
else:
    print("ОШИБКА: Не удалось подключиться через SSH")
PYEOF
""")
        output = stdout.read().decode('utf-8', errors='replace')
        print(output)
        
    finally:
        ssh.close()

if __name__ == "__main__":
    main()

