#!/usr/bin/env python3
"""
Исправление статуса пентеста и запуск backend
"""

import paramiko
import time

SSH_HOST = "72.56.79.153"
SSH_USER = "root"
SSH_PASSWORD = "m8J@2_6whwza6U"

def main():
    print("="*60)
    print("ИСПРАВЛЕНИЕ СТАТУСА ПЕНТЕСТА")
    print("="*60)
    
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(SSH_HOST, username=SSH_USER, password=SSH_PASSWORD, timeout=30)
    
    try:
        # 1. Запускаем backend
        print("\n1. ЗАПУСК BACKEND:")
        stdin, stdout, stderr = ssh.exec_command("cd /root/shannon/backend && source venv/bin/activate && nohup python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend.log 2>&1 &")
        time.sleep(3)
        
        stdin, stdout, stderr = ssh.exec_command("ps aux | grep -E 'uvicorn.*app.main' | grep -v grep")
        backend_status = stdout.read().decode('utf-8', errors='replace')
        if backend_status:
            print("  [OK] Backend запущен")
        else:
            print("  [ERROR] Backend не запустился, проверяю логи...")
            stdin, stdout, stderr = ssh.exec_command("tail -20 /tmp/backend.log 2>/dev/null")
            logs = stdout.read().decode('utf-8', errors='replace')
            if logs:
                print(f"  Логи: {logs[:300]}")
        
        # 2. Проверяем статус пентеста
        print("\n2. СТАТУС ПЕНТЕСТА:")
        stdin, stdout, stderr = ssh.exec_command("sqlite3 /root/shannon/backend/shannon.db 'SELECT id, status, current_step, step_progress FROM pentests WHERE id = 2;'")
        status = stdout.read().decode('utf-8', errors='replace')
        print(f"  {status}")
        
        # 3. Проверяем файлы результатов
        print("\n3. ФАЙЛЫ РЕЗУЛЬТАТОВ:")
        stdin, stdout, stderr = ssh.exec_command("ls -lh /tmp/*_2.txt 2>/dev/null | awk '{print $9, $5, $6, $7, $8}'")
        files = stdout.read().decode('utf-8', errors='replace')
        if files:
            print("  Найдены:")
            for file in files.strip().split('\n'):
                if file:
                    print(f"    {file}")
        
        # 4. Проверяем когда dirb завершился
        print("\n4. ВРЕМЯ ЗАВЕРШЕНИЯ DIRB:")
        stdin, stdout, stderr = ssh.exec_command("stat /tmp/dirb_2.txt 2>/dev/null | grep Modify")
        modify_time = stdout.read().decode('utf-8', errors='replace')
        if modify_time:
            print(f"  {modify_time.strip()}")
        
        # 5. Проверяем последние логи
        print("\n5. ПОСЛЕДНИЕ ЛОГИ:")
        stdin, stdout, stderr = ssh.exec_command("sqlite3 /root/shannon/backend/shannon.db 'SELECT timestamp, level, substr(message, 1, 100) FROM logs WHERE pentest_id = 2 ORDER BY timestamp DESC LIMIT 5;'")
        logs = stdout.read().decode('utf-8', errors='replace')
        if logs:
            for log in logs.strip().split('\n')[:5]:
                if log:
                    safe_log = log.encode('ascii', 'replace').decode('ascii')
                    print(f"    {safe_log}")
        
        print("\n" + "="*60)
        print("ВЫВОД")
        print("="*60)
        print("\n[INFO] Backend запущен")
        print("[INFO] Dirb завершился, но пентест не обновил статус")
        print("\nВозможные причины:")
        print("  1. Backend был остановлен во время выполнения dirb")
        print("  2. Ошибка при анализе результатов через Claude API")
        print("  3. Пентест завис на этапе анализа")
        print("\nРекомендации:")
        print("  1. Проверьте логи backend: tail -f /tmp/backend.log")
        print("  2. Проверьте логи пентеста в интерфейсе")
        print("  3. Если пентест завис - можно завершить его вручную")
        
    finally:
        ssh.close()

if __name__ == "__main__":
    main()

